name: Nightly Scrape

on:
  schedule:
    # Run at 3 AM Serbian time (2:00 UTC in winter, 1:00 UTC in summer)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  # List scrapers run in parallel
  scrape-planeta:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run Planeta Sport scraper
        run: pnpm tsx src/scraper/stores/planeta.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  scrape-buzz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run Buzz scraper
        run: pnpm tsx src/scraper/stores/buzz.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  scrape-officeshoes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run Office Shoes scraper
        run: pnpm tsx src/scraper/stores/officeshoes.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  scrape-djaksport:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run DjakSport scraper
        run: pnpm tsx src/scraper/stores/djaksport.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  scrape-nsport:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run N-Sport scraper
        run: pnpm tsx src/scraper/stores/nsport.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  scrape-sportvision:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run SportVision scraper
        run: pnpm tsx src/scraper/stores/sportvision.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  # Detail scrapers run after list scrapers complete
  scrape-details:
    runs-on: ubuntu-latest
    needs: [scrape-planeta, scrape-buzz, scrape-officeshoes, scrape-djaksport, scrape-nsport, scrape-sportvision]
    if: always() # Run even if some scrapers failed
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run Planeta Details
        run: pnpm tsx src/scraper/stores/planeta-details.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 45
        continue-on-error: true
      - name: Run Buzz Details
        run: pnpm tsx src/scraper/stores/buzz-details.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 45
        continue-on-error: true
      - name: Run OfficeShoes Details
        run: pnpm tsx src/scraper/stores/officeshoes-details.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 45
        continue-on-error: true
      - name: Run DjakSport Details
        run: pnpm tsx src/scraper/stores/djaksport-details.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 45
        continue-on-error: true
      - name: Run N-Sport Details
        run: pnpm tsx src/scraper/stores/nsport-details.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 45
        continue-on-error: true
      - name: Run SportVision Details
        run: pnpm tsx src/scraper/stores/sportvision-details.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 45
        continue-on-error: true
