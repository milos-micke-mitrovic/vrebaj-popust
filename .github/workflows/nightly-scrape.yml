name: Nightly Scrape

on:
  schedule:
    # Run at 3 AM Serbian time (2:00 UTC in winter, 1:00 UTC in summer)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  # List scrapers run in parallel
  scrape-planeta:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run Planeta Sport scraper
        run: pnpm tsx src/scraper/stores/planeta.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  scrape-buzz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run Buzz scraper
        run: pnpm tsx src/scraper/stores/buzz.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  scrape-officeshoes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run Office Shoes scraper
        run: pnpm tsx src/scraper/stores/officeshoes.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  scrape-djaksport:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run DjakSport scraper
        run: pnpm tsx src/scraper/stores/djaksport.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  scrape-nsport:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run N-Sport scraper
        run: pnpm tsx src/scraper/stores/nsport.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  scrape-sportvision:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run SportVision scraper
        run: pnpm tsx src/scraper/stores/sportvision.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  scrape-intersport:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - name: Run Intersport scraper
        run: pnpm tsx src/scraper/stores/intersport.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 30

  # Detail scrapers run in parallel, each waits only for its list scraper
  scrape-planeta-details:
    runs-on: ubuntu-latest
    needs: scrape-planeta
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run Planeta Details
        run: pnpm tsx src/scraper/stores/planeta-details.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 180

  scrape-buzz-details:
    runs-on: ubuntu-latest
    needs: scrape-buzz
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run Buzz Details
        run: pnpm tsx src/scraper/stores/buzz-details.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 180

  scrape-officeshoes-details:
    runs-on: ubuntu-latest
    needs: scrape-officeshoes
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run OfficeShoes Details
        run: pnpm tsx src/scraper/stores/officeshoes-details.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 180

  scrape-nsport-details:
    runs-on: ubuntu-latest
    needs: scrape-nsport
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run N-Sport Details
        run: pnpm tsx src/scraper/stores/nsport-details.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 180

  scrape-sportvision-details:
    runs-on: ubuntu-latest
    needs: scrape-sportvision
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - run: npx puppeteer browsers install chrome
      - name: Run SportVision Details
        run: pnpm tsx src/scraper/stores/sportvision-details.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 180

  scrape-intersport-details:
    runs-on: ubuntu-latest
    needs: scrape-intersport
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - run: pnpm install
      - run: pnpm prisma generate
      - name: Run Intersport Details
        run: pnpm tsx src/scraper/stores/intersport-details.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        timeout-minutes: 180
